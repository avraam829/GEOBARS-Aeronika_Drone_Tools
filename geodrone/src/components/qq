    /*
    const scale = 30;
    const options = {
        obj: '/Radio_tower.glb',  
        type: 'gltf',
        scale: { x: scale, y: scale, z: scale },
        units: 'meters',
        rotation: { x: 90, y: -90, z: 0 },
        anchor: 'center'
    };
    window.tb.loadObj(options, (model) => {
      const modelInstance = model.setCoords([lon, lat, groundAlt]);
      modelInstance.setRotation({ x: 0, y: 0, z: 241 });
      window.tb.add(modelInstance);
      console.log("Model added successfully");
    });
    const options2 = {
        obj: '/drone_samolet.glb',  
        type: 'gltf',
        scale: { x: scale, y: scale, z: scale },
        units: 'meters',
        rotation: { x: 90, y: -90, z: 0 },
        anchor: 'center'
    };
    window.tb.loadObj(options2, (model) => {
      const modelInstance = model.setCoords([lon, lat, groundAlt+1000]);
      modelInstance.setRotation({ x: 0, y: 0, z: 241 });
      window.tb.add(modelInstance);
      console.log("Model added successfully");
    });
    */

    import React, { useEffect, useRef, useState } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';
import SphereManager from './SphereManager';
import HeightInput from './HeightInput';
import Highbar from './Highbar'; // Import Highbar

const MapContainer = ({ mapStyle }) => {
  const mapContainerRef = useRef(null);
  const mapRef = useRef(null);
  const [showHeightInput, setShowHeightInput] = useState(false);
  const [sphereCoords, setSphereCoords] = useState(null);
  const [sphereHeight, setSphereHeight] = useState(100);
  const exaggeration = 3;
  const [routeCoordinates, setRouteCoordinates] = useState([]); // для высотного отображения
  const [isAddingSpheres, setIsAddingSpheres] = useState(false);
  const [map, setMap] = useState(null);
  
  const isAddingSpheresRef = useRef(isAddingSpheres); // Ref to track the current state of isAddingSpheres
  useEffect(() => {
    isAddingSpheresRef.current = isAddingSpheres;
  }, [isAddingSpheres]); // Update ref whenever isAddingSpheres changes

  const cameraState = useRef({
    center: [44.621762, 39.091278],
    zoom: 20,
    pitch: 60,
    bearing: 41,
  });

  const [coordinates, setCoordinates] = useState({ lng: 0, lat: 0, height: 0 });

  useEffect(() => {
    if (mapRef.current) {
      mapRef.current.remove();
    }

    mapboxgl.accessToken = 'your-mapbox-token';
    mapRef.current = new mapboxgl.Map({
      container: mapContainerRef.current,
      style: mapStyle,
      center: cameraState.current.center,
      zoom: cameraState.current.zoom,
      pitch: cameraState.current.pitch,
      bearing: cameraState.current.bearing,
      antialias: true,
    });

    mapRef.current.on('style.load', () => {
      mapRef.current.addSource('mapbox-dem', {
        type: 'raster-dem',
        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
        tileSize: 512,
        maxzoom: 14,
      });

      mapRef.current.setTerrain({
        source: 'mapbox-dem',
        exaggeration: exaggeration,
      });

      SphereManager.reinitialize(mapRef.current);
    });

    mapRef.current.addControl(new mapboxgl.NavigationControl(), 'top-right');

    const onClick = (e) => {
      if (!isAddingSpheresRef.current) return; // Using the ref to check the current value of isAddingSpheres
      setSphereCoords([e.lngLat.lng, e.lngLat.lat]);
      setShowHeightInput(true);
    };

    mapRef.current.on('click', onClick);

    mapRef.current.on('mousemove', async (e) => {
      const lngLat = e.lngLat;
      const height = await mapRef.current.queryTerrainElevation([lngLat.lng, lngLat.lat]) / exaggeration;
      setCoordinates({
        lng: lngLat.lng.toFixed(5),
        lat: lngLat.lat.toFixed(5),
        height: height.toFixed(2),
      });
    });

    mapRef.current.on('moveend', () => {
      const center = mapRef.current.getCenter();
      const zoom = mapRef.current.getZoom();
      const pitch = mapRef.current.getPitch();
      const bearing = mapRef.current.getBearing();

      cameraState.current = {
        center: [center.lng, center.lat],
        zoom,
        pitch,
        bearing,
      };
    });

    // Update map dimensions on resize
    let resizeTimeout;
    const resizeObserver = new ResizeObserver(() => {
      if (resizeTimeout) {
        clearTimeout(resizeTimeout);
      }
    
      // Delay resize call for 300ms (animation panel time)
      resizeTimeout = setTimeout(() => {
        mapRef.current.resize();
      }, 300);
    });
    resizeObserver.observe(mapContainerRef.current);

    return () => {
      mapRef.current.off('click', onClick);
      mapRef.current.off('mousemove');
      resizeObserver.disconnect(); // Stop observing size changes
    };
  }, [mapStyle]);

  const addSphere = async () => {
    if (sphereCoords) {
      await SphereManager.addSphere(mapRef.current, sphereCoords, sphereHeight, exaggeration);

      // Add new sphere coordinates to route
      setRouteCoordinates(prev => [...prev, [...sphereCoords, sphereHeight]]);
      
      setShowHeightInput(false);
      setSphereCoords(null);
      setSphereHeight(100);
    }
  };

  return (
    <div ref={mapContainerRef} style={{ width: '100%', height: '100vh', position: 'relative' }}>
      {showHeightInput && (
        <HeightInput 
          height={sphereHeight} 
          setHeight={setSphereHeight} 
          onAdd={addSphere} 
        />
      )}
      <button 
        onClick={() => setIsAddingSpheres(prev => !prev)}
        style={{
          position: 'absolute',
          top: '200px',
          left: '10px',
          zIndex: 1000,
          padding: '10px 20px',
          backgroundColor: isAddingSpheres ? 'red' : 'green',
          color: 'white',
          border: 'none',
          borderRadius: '5px',
          cursor: 'pointer',
        }}
      >
        {isAddingSpheres ? 'Выключить режим добавления' : 'Включить режим добавления'}
      </button>

      {/* Block for displaying coordinates and height */}
      <div style={{
        position: 'absolute', 
        top: '10px', 
        right: '50px', 
        backgroundColor: 'rgba(255, 255, 255, 0.8)', 
        padding: '5px', 
        borderRadius: '5px',
        fontSize: '14px',
        zIndex: 100
      }}>
        <div>Longitude: {coordinates.lng}</div>
        <div>Latitude: {coordinates.lat}</div>
        <div>Elevation: {coordinates.height} m</div>
      </div>

      {/* Highbar at the bottom of the map */}
      <Highbar map={mapRef.current} routeCoordinates={routeCoordinates} />
    </div>
  );
};

export default MapContainer;
